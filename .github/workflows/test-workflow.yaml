name: Greet Everyone
# This workflow is triggered on pushes to the repository.
on: [push]

# Environment variables available to all jobs and steps in this workflow
env:
  GKE_PROJECT: ${{ secrets.GKE_PROJECT }}
  GKE_EMAIL: ${{ secrets.GKE_EMAIL }}
  GITHUB_SHA: ${{ github.sha }}
  GKE_ZONE: us-west1-a
  GKE_CLUSTER: example-gke-cluster
  IMAGE: gke-test
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_DEFAULT_REGION: us-east-1
  KOPS_STATE_STORE: ${{ secrets.KOPS_STATE_STORE }}

jobs:
  build:
    # Job name is Greeting
    name: Greeting
    # This job runs on Linux
    runs-on: ubuntu-18.04
    steps:
      # Checkout the repository
      - name: Checkout
        uses: actions/checkout@v1
      # Set up kops
      - name: Set up kops
        run: |
          curl -o kops --location https://github.com/kubernetes/kops/releases/download/1.13.2/kops-linux-amd64
          chmod u+x ./kops
          export PATH=$(pwd):$PATH
          kops version
      # This step prints an output (time) from the previous step's action.
      - name: Apply kops update DRY RUN
        run: |
          export PATH=$(pwd):$PATH
          cd ./clusters/aws/kops
          ./kops.sh --name dev-ex --update true --dry-run true
      - name: Apply kops update NOT DRY RUN
        run: |
          export PATH=$(pwd):$PATH
          cd ./clusters/aws/kops
          ./kops.sh --name dev-ex --update true --dry-run false
      - name: Apply kops rolling update DRY RUN
        run: |
          export PATH=$(pwd):$PATH
          cd ./clusters/aws/kops
          ./kops.sh --name dev-ex --rolling-update true --cloud-only true --dry-run false          